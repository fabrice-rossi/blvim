# Boltzmann–Lotka–Volterra Interaction Model

`blvim` implements A. Wilson’s **Boltzmann–Lotka–Volterra (BLV)
interaction model**. The model is described in [Wilson, A. (2008),
“Boltzmann, Lotka and Volterra and spatial structural evolution: an
integrated methodology for some dynamical systems”, J. R. Soc.
Interface, 5:865–871](http://dx.doi.org/10.1098/rsif.2007.1288).

The package’s primary goal is to provide a fast implementation of the
BLV model, complete with a collection of tools designed to explore the
results through statistical summaries and graphical representations. The
secondary goal is to facilitate the systematic assessment of how model
parameters impact the results, again using summaries and graphical
representations (see
[`vignette("grid")`](https://fabrice-rossi.github.io/blvim/articles/grid.md)
for details on this aspect).

## Installation

You can install the development version of `blvim` from
[GitHub](https://github.com/) with:

``` r
# install.packages("pak")
pak::pak("fabrice-rossi/blvim")
```

## Spatial interaction models

**Spatial interaction models** aim to estimate flows between locations,
such as workers commuting from residential zones to employment zones.
The `blvim` package focuses on the maximum entropy models developed by
Alan Wilson. See
[`vignette("theory")`](https://fabrice-rossi.github.io/blvim/articles/theory.md)
for the theoretical background.

In practice, if we have \\n\\ origin locations and \\p\\ destination
locations, the goal is to compute a flow matrix \\(Y\_{ij})\_{1\leq
i\leq n, 1\leq j\leq p}\\, where \\Y\_{ij}\\ is the flow from origin
\\i\\ to destination \\j\\. This computation relies on characteristics
of the origin and destination locations, along with a matrix of exchange
difficulties, known as a **cost matrix**, \\(c\_{ij})\_{1\leq i\leq n,
1\leq j\leq p}\\. For example, \\c\_{ij}\\ can represent the distance
between origin \\i\\ and destination \\j\\.

## Usage

The package is loaded in a standard way.

``` r
library(blvim)
```

### Input data

To compute a spatial interaction model with `blvim`, you need at least a
cost matrix. The package comes with distance data for a selection of
large French cities. We use the 30 largest ones as origin locations and
the 20 smallest ones as destination locations. The cost matrix is the
distance between the cities (in meters).

``` r
## 30 largest cities
origins <- french_cities[1:30, c("th_longitude", "th_latitude")]
## 20 smallest cities
destinations <- french_cities[(nrow(french_cities) - 19):nrow(french_cities), c("th_longitude", "th_latitude")]
## cost matrix
cost_matrix <- french_cities_distance[1:30, (nrow(french_cities) - 19):nrow(french_cities)]
rownames(cost_matrix) <- french_cities[1:30, "name"]
colnames(cost_matrix) <- french_cities[(nrow(french_cities) - 19):nrow(french_cities), "name"]
```

Additionally, since we focus on **production-constrained models**, we
must specify the production for each origin location (a vector of
positive values \\(X_i)\_{1\leq i\leq n}\\). Here, we assume a common
unitary production.

``` r
X <- rep(1, nrow(origins))
```

Finally, the simple **static** model requires an attractiveness value
for each destination location, a vector of positive values
\\(Z_j)\_{1\leq j\leq p}\\. We again assume a common unitary
attractiveness.

``` r
Z <- rep(1, nrow(destinations))
```

We could use the population of the cities as production constraints for
instance.

### Static models

In Wilson’s production-constrained maximum entropy model, the flows are
given by

\\ Y\_{ij} = \frac{X_iZ_j^{\alpha}\exp(-\beta
c\_{ij})}{\sum\_{k=1}^pZ_k^{\alpha}\exp(-\beta c\_{ik})}, \\

where \\\alpha\\ is a return-to-scale parameter and \\\beta\\ is the
inverse of a cost scale parameter. Note that the flow matrix is
**production-constrained**, meaning that the total outgoing flow from
any origin location is equals the production of that location:

\\ \forall i,\quad X_i=\sum\_{j=1}^{p}Y\_{ij}. \\

The model is obtained using the
[`static_blvim()`](https://fabrice-rossi.github.io/blvim/reference/static_blvim.md)
function:

``` r
a_model <- static_blvim(cost_matrix, X, alpha = 1.1, beta = 1 / 500000, Z)
a_model
#> Spatial interaction model with 30 origin locations and 20 destination locations
#> • Model: Wilson's production constrained
#> • Parameters: return to scale (alpha) = 1.1 and inverse cost scale (beta) =
#> 2e-06
```

Several functions are provided to extract parts of the result. In
particular
[`flows()`](https://fabrice-rossi.github.io/blvim/reference/flows.md)
returns the flow matrix \\Y\\.

``` r
a_model_flows <- flows(a_model)
```

which can be displayed using, for instance, the
[`image()`](https://rdrr.io/r/graphics/image.html) function.

``` r
par(mar = rep(0.1, 4))
image(t(a_model_flows)[, 30:1],
  col = gray.colors(20, start = 1, end = 0),
  axes = FALSE,
  frame = TRUE
)
```

![](reference/figures/README-a_flow-1.png)

In this representation, each row shows the flows from one origin
location to all destination locations. The package also provides a
[`ggplot2::autoplot()`](https://ggplot2.tidyverse.org/reference/autoplot.html)
function, which can be used as follows:

``` r
library(ggplot2)
autoplot(a_model, "full") +
  scale_fill_gradient(low = "white", high = "black") +
  coord_fixed()
```

![](reference/figures/README-a_flow_ggplot2-1.png)

``` r
b_model <- static_blvim(cost_matrix, X, alpha = 1.1, beta = 1 / 100000, Z)
b_model
#> Spatial interaction model with 30 origin locations and 20 destination locations
#> • Model: Wilson's production constrained
#> • Parameters: return to scale (alpha) = 1.1 and inverse cost scale (beta) =
#> 1e-05
```

``` r
autoplot(b_model) +
  scale_fill_gradient(low = "white", high = "black") +
  coord_fixed()
```

![](reference/figures/README-b_flow-1.png)

As the two figures above exemplify, different values of the parameters
\\\alpha\\ and \\\beta\\ result in more or less concentrated flows.

### Dynamic models

A. Wilson’s **Boltzmann–Lotka–Volterra (BLV) interaction model** builds
upon the production-constrained maximum entropy model. The core idea is
to update the attractiveness of the destination locations based on their
incoming flows.

Ideally, we aim for the following condition to hold in the limit:

\\ Z_j =\sum\_{i=1}^{n}Y\_{ij}, \\

where the flows are given by the equations above. The model is estimated
using the
[`blvim()`](https://fabrice-rossi.github.io/blvim/reference/blvim.md)
function as follows.

``` r
a_blv_model <- blvim(cost_matrix, X, alpha = 1.1, beta = 1 / 500000, Z)
a_blv_model
#> Spatial interaction model with 30 origin locations and 20 destination locations
#> • Model: Wilson's production constrained
#> • Parameters: return to scale (alpha) = 1.1 and inverse cost scale (beta) =
#> 2e-06
#> ℹ The BLV model converged after 4800 iterations.
```

Notice that we start with some initial values of the attractiveness, but
the final values are different. These final values can be obtained using
the
[`attractiveness()`](https://fabrice-rossi.github.io/blvim/reference/attractiveness.md)
function (and visualised here using a bar plot).

``` r
par(mar = c(0.1, 4, 1, 0))
a_final_Z <- attractiveness(a_blv_model)
barplot(a_final_Z)
```

![](reference/figures/README-a_blv_Z-1.png) In this particular example,
one destination location acts as a global attractor of all the flows.
This pattern is also visible in the final flow matrix.

``` r
autoplot(a_blv_model) +
  scale_fill_gradient(low = "white", high = "black")
```

![](reference/figures/README-a_blv_flow-1.png)

The
[`autoplot()`](https://ggplot2.tidyverse.org/reference/autoplot.html)
function can also be used to show the destination flows or the
attractivenesses values:

``` r
autoplot(a_blv_model, "attractiveness", with_names = TRUE) +
  coord_flip()
```

![](reference/figures/README-a_blv_Z_ggplot2-1.png)

Naturally, the results are strongly influenced by the parameters, as
shown in this second example.

``` r
b_blv_model <- blvim(cost_matrix, X, alpha = 1.1, beta = 1 / 50000, Z)
b_blv_model
#> Spatial interaction model with 30 origin locations and 20 destination locations
#> • Model: Wilson's production constrained
#> • Parameters: return to scale (alpha) = 1.1 and inverse cost scale (beta) =
#> 2e-05
#> ℹ The BLV model converged after 5700 iterations.
```

``` r
autoplot(b_blv_model, "attractiveness", with_names = TRUE) +
  coord_flip()
```

![](reference/figures/README-b_blv_Z-1.png)

``` r
autoplot(b_blv_model, with_names = TRUE) +
  scale_fill_gradient(low = "white", high = "black") +
  theme(axis.text.x = element_text(angle = 90))
```

![](reference/figures/README-b_blv_flow-1.png)

`bvlim` offers a collection of graphical representations that can
leverage the data associated to the origin and destination locations.
For instance, we can display the full flows using geographical
coordinates of the cities.

``` r
origin_positions(b_blv_model) <- as.matrix(origins)
destination_positions(b_blv_model) <- as.matrix(destinations)
autoplot(b_blv_model,
  with_positions = TRUE,
  arrow = arrow(length = unit(0.01, "npc"))
) +
  scale_linewidth(range = c(0, 1.5)) +
  coord_sf(crs = "epsg:4326") +
  geom_point(
    data = origins,
    mapping = aes(x = th_longitude, y = th_latitude), inherit.aes = FALSE,
    color = "blueviolet", alpha = 0.5, size = 3
  ) +
  geom_point(
    data = destinations,
    mapping = aes(x = th_longitude, y = th_latitude), inherit.aes = FALSE,
    color = "darkorange", alpha = 0.5, size = 3
  )
```

![](reference/figures/README-b_blv_france-1.png)

# Package index

## Creating spatial interaction models

Functions for creating spatial interaction models and extracting their
parameters.

- [`static_blvim()`](https://fabrice-rossi.github.io/blvim/reference/static_blvim.md)
  : Compute flows between origin and destination locations
- [`blvim()`](https://fabrice-rossi.github.io/blvim/reference/blvim.md)
  : Compute an equilibrium solution of the Boltzmann–Lotka–Volterra
  model
- [`costs()`](https://fabrice-rossi.github.io/blvim/reference/costs.md)
  : Extract the cost matrix used to compute this model
- [`inverse_cost()`](https://fabrice-rossi.github.io/blvim/reference/inverse_cost.md)
  : Extract the inverse cost scale parameter used to compute this model
- [`return_to_scale()`](https://fabrice-rossi.github.io/blvim/reference/return_to_scale.md)
  : Extract the return to scale parameter used to compute this model
- [`sim_is_bipartite()`](https://fabrice-rossi.github.io/blvim/reference/sim_is_bipartite.md)
  : Reports whether the spatial interaction model is bipartite
- [`destination_names()`](https://fabrice-rossi.github.io/blvim/reference/destination_names.md)
  [`` `destination_names<-`() ``](https://fabrice-rossi.github.io/blvim/reference/destination_names.md)
  : Names of destination locations in a spatial interaction model
- [`location_names()`](https://fabrice-rossi.github.io/blvim/reference/location_names.md)
  [`` `location_names<-`() ``](https://fabrice-rossi.github.io/blvim/reference/location_names.md)
  : Names of origin and destination locations in a spatial interaction
  model
- [`origin_names()`](https://fabrice-rossi.github.io/blvim/reference/origin_names.md)
  [`` `origin_names<-`() ``](https://fabrice-rossi.github.io/blvim/reference/origin_names.md)
  : Names of origin locations in a spatial interaction model
- [`destination_positions()`](https://fabrice-rossi.github.io/blvim/reference/destination_positions.md)
  [`` `destination_positions<-`() ``](https://fabrice-rossi.github.io/blvim/reference/destination_positions.md)
  : positions of destination locations in a spatial interaction model
- [`location_positions()`](https://fabrice-rossi.github.io/blvim/reference/location_positions.md)
  [`` `location_positions<-`() ``](https://fabrice-rossi.github.io/blvim/reference/location_positions.md)
  : Positions of origin and destination locations in a spatial
  interaction model
- [`origin_positions()`](https://fabrice-rossi.github.io/blvim/reference/origin_positions.md)
  [`` `origin_positions<-`() ``](https://fabrice-rossi.github.io/blvim/reference/origin_positions.md)
  : Positions of origin locations in a spatial interaction model

## Using spatial interaction models

Functions for getting properties of spatial interaction models.

- [`attractiveness()`](https://fabrice-rossi.github.io/blvim/reference/attractiveness.md)
  : Extract the attractivenesses from a spatial interaction model object
- [`destination_flow()`](https://fabrice-rossi.github.io/blvim/reference/destination_flow.md)
  : Compute the flows incoming at each destination location
- [`diversity()`](https://fabrice-rossi.github.io/blvim/reference/diversity.md)
  : Compute the diversity of the destination flows in a spatial
  interaction model
- [`flows()`](https://fabrice-rossi.github.io/blvim/reference/flows.md)
  : Extract the flow matrix from a spatial interaction model object
- [`flows_df()`](https://fabrice-rossi.github.io/blvim/reference/flows_df.md)
  : Extract the flow matrix from a spatial interaction model object in
  data frame format
- [`production()`](https://fabrice-rossi.github.io/blvim/reference/production.md)
  : Extract the production constraints from a spatial interaction model
  object
- [`sim_converged()`](https://fabrice-rossi.github.io/blvim/reference/sim_converged.md)
  : Reports whether the spatial interaction model construction converged
- [`sim_iterations()`](https://fabrice-rossi.github.io/blvim/reference/sim_iterations.md)
  : Returns the number of iterations used to produce this spatial
  interaction model

## Non bipartite models

Functions that apply only to non bipartite models.

- [`is_terminal()`](https://fabrice-rossi.github.io/blvim/reference/is_terminal.md)
  : Report whether locations are terminal sites or not
- [`nd_graph()`](https://fabrice-rossi.github.io/blvim/reference/nd_graph.md)
  : Compute the Nystuen and Dacey graph for a spatial interaction model
- [`terminals()`](https://fabrice-rossi.github.io/blvim/reference/terminals.md)
  : Compute terminals for a spatial interaction model

## Multiple models

Functions to create and use multiple spatial interaction models using a
grid of parameters.

- [`costs(`*`<sim_list>`*`)`](https://fabrice-rossi.github.io/blvim/reference/costs.sim_list.md)
  : Extract the common cost matrix from a collection of spatial
  interaction models
- [`grid_attractiveness()`](https://fabrice-rossi.github.io/blvim/reference/grid_attractiveness.md)
  : Extract all the attractivenesses from a collection of spatial
  interaction models
- [`grid_autoplot()`](https://fabrice-rossi.github.io/blvim/reference/grid_autoplot.md)
  : Create a complete ggplot for spatial interaction models in a data
  frame
- [`grid_blvim()`](https://fabrice-rossi.github.io/blvim/reference/grid_blvim.md)
  : Compute a collection of Boltzmann–Lotka–Volterra model solutions
- [`grid_destination_flow()`](https://fabrice-rossi.github.io/blvim/reference/grid_destination_flow.md)
  : Extract all the destination flows from a collection of spatial
  interaction models
- [`grid_diversity()`](https://fabrice-rossi.github.io/blvim/reference/grid_diversity.md)
  : Compute diversities for a collection of spatial interaction models
- [`grid_is_terminal()`](https://fabrice-rossi.github.io/blvim/reference/grid_is_terminal.md)
  : Extract all terminal status from a collection of spatial interaction
  models
- [`grid_sim_converged()`](https://fabrice-rossi.github.io/blvim/reference/grid_sim_converged.md)
  : Reports the convergence statuses of a collection of spatial
  interaction models
- [`grid_sim_iterations()`](https://fabrice-rossi.github.io/blvim/reference/grid_sim_iterations.md)
  : Returns the number of iterations used to produce of a collection of
  spatial interaction models
- [`grid_var_autoplot()`](https://fabrice-rossi.github.io/blvim/reference/grid_var_autoplot.md)
  : Create a complete variability plot for spatial interaction models in
  a data frame
- [`median(`*`<sim_list>`*`)`](https://fabrice-rossi.github.io/blvim/reference/median.sim_list.md)
  : Compute the "median" of a collection of spatial interaction models
- [`sim_df()`](https://fabrice-rossi.github.io/blvim/reference/sim_df.md)
  : Create a spatial interaction models data frame from a collection of
  interaction models
- [`sim_column()`](https://fabrice-rossi.github.io/blvim/reference/sim_column.md)
  : Get the collection of spatial interaction models from a sim data
  frame
- [`sim_distance()`](https://fabrice-rossi.github.io/blvim/reference/sim_distance.md)
  : Compute all pairwise distances between the spatial interaction
  models in a collection
- [`sim_list()`](https://fabrice-rossi.github.io/blvim/reference/sim_list.md)
  : Create a sim_list object from a list of spatial interaction objects

## Graphical representations

Functions that provide graphical representations of spatial interaction
models.

- [`autoplot(`*`<sim>`*`)`](https://fabrice-rossi.github.io/blvim/reference/autoplot.sim.md)
  : Create a complete ggplot for a spatial interaction model
- [`autoplot(`*`<sim_df>`*`)`](https://fabrice-rossi.github.io/blvim/reference/autoplot.sim_df.md)
  : Create a complete ggplot for a spatial interaction models data frame
- [`autoplot(`*`<sim_list>`*`)`](https://fabrice-rossi.github.io/blvim/reference/autoplot.sim_list.md)
  : Create a complete variability for a collection of spatial
  interaction models
- [`fortify(`*`<sim>`*`)`](https://fabrice-rossi.github.io/blvim/reference/fortify.sim.md)
  : Turn a spatial interaction model into a data frame
- [`fortify(`*`<sim_list>`*`)`](https://fabrice-rossi.github.io/blvim/reference/fortify.sim_list.md)
  : Turn a collection of spatial interaction models into a data frame
- [`grid_autoplot()`](https://fabrice-rossi.github.io/blvim/reference/grid_autoplot.md)
  : Create a complete ggplot for spatial interaction models in a data
  frame
- [`grid_var_autoplot()`](https://fabrice-rossi.github.io/blvim/reference/grid_var_autoplot.md)
  : Create a complete variability plot for spatial interaction models in
  a data frame

## Data sets

- [`french_cities`](https://fabrice-rossi.github.io/blvim/reference/french_cities.md)
  : French cities
- [`french_cities_distance`](https://fabrice-rossi.github.io/blvim/reference/french_cities_distance.md)
  [`french_cities_time`](https://fabrice-rossi.github.io/blvim/reference/french_cities_distance.md)
  : French cities distances
- [`french_departments`](https://fabrice-rossi.github.io/blvim/reference/french_departments.md)
  : French departments
- [`french_regions`](https://fabrice-rossi.github.io/blvim/reference/french_regions.md)
  : French regions

# Articles

### All vignettes

- [Systematic exploration of the BLV solution
  space](https://fabrice-rossi.github.io/blvim/articles/grid.md):
- [Theoretical
  Background](https://fabrice-rossi.github.io/blvim/articles/theory.md):
